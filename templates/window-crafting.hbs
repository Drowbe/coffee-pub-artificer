{{!-- Artificer Crafting Station - 4-zone layout: [recipes][ingredients][crafting area][result] --}}
{{!-- Design follows Quick Encounter: header, sectioned body, action bar --}}

<div class="crafting-window-root">

    {{!-- HEADER (Quick Encounter style) --}}
    <header class="crafting-window-header">
        <div class="crafting-window-header-content">
            <div class="crafting-window-header-icon">
                {{#if crafterImg}}
                <img src="{{crafterImg}}" alt="" class="crafting-window-header-portrait" />
                {{else}}
                <i class="fa-solid fa-hammer"></i>
                {{/if}}
            </div>
            <div class="crafting-window-header-title-block">
                <div class="crafting-window-header-title">Artificer Crafting Station</div>
                <div class="crafting-window-header-crafter">{{#if crafterName}}{{crafterName}}{{else}}Select a crafter{{/if}}</div>
            </div>
        </div>
    </header>

    {{!-- BODY: 4 zones --}}
    <div class="crafting-window-body">
        {{!-- Zone 1: Recipes --}}
        <aside class="crafting-zone crafting-zone-recipes">
            <section class="crafting-zone-section">
                <h3 class="crafting-zone-section-title">Recipes</h3>
                <div class="crafting-zone-section-input-wrap">
                    <input type="text" id="{{appId}}-filter-recipes" class="crafting-zone-section-input" placeholder="Search recipes..." value="{{filterRecipeSearch}}" dir="ltr" />
                    <button type="button" class="crafting-zone-section-input-clear" data-action="clearRecipeSearch" title="Clear search" aria-label="Clear search"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="crafting-zone-filters-row">
                    <select id="{{appId}}-filter-recipe-journal" class="crafting-zone-select" title="Filter by journal">
                        {{#each recipeJournalOptions}}
                        <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                        {{/each}}
                    </select>
                </div>
                <div class="crafting-zone-recipes-list">
                    {{#each knownCombinations}}
                    <div class="crafting-recipe-row {{#if this.selected}}crafting-recipe-row-selected{{/if}}" data-recipe-id="{{this.recipeId}}" data-action="selectRecipe" tabindex="0" title="Click to load recipe into crafting bench">
                        <img src="{{this.resultImg}}" alt="" class="crafting-recipe-result-img" />
                        <div class="crafting-recipe-content">
                            <span class="crafting-recipe-result">{{this.result}}</span>
                            <span class="crafting-recipe-tags">{{#each this.tags}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}</span>
                        </div>
                        {{#if this.canCraft}}<i class="crafting-recipe-craftable-icon fa-solid fa-hammer" title="All ingredients available"></i>{{/if}}
                    </div>
                    {{else}}
                    <div class="crafting-zone-empty">No recipes loaded. Configure the recipe journal in module settings.</div>
                    {{/each}}
                </div>
            </section>
        </aside>

        {{!-- Zone 2: Components --}}
        <aside class="crafting-zone crafting-zone-ingredients">
            <section class="crafting-zone-section">
                <h3 class="crafting-zone-section-title">Components</h3>
                <div class="crafting-zone-section-input-wrap">
                    <input type="text" id="{{appId}}-filter-search" class="crafting-zone-section-input" placeholder="Search components..." value="{{filterSearch}}" dir="ltr" />
                    <button type="button" class="crafting-zone-section-input-clear" data-action="clearComponentSearch" title="Clear search" aria-label="Clear search"><i class="fa-solid fa-times"></i></button>
                </div>
                <div class="crafting-zone-filters-row">
                    <select id="{{appId}}-filter-type" class="crafting-zone-select" title="Filter by type (Component, Creation, Tool)">
                        {{#each typeOptions}}
                        <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                        {{/each}}
                    </select>
                    <select id="{{appId}}-filter-family" class="crafting-zone-select" title="Filter by family (options depend on type)">
                        {{#each familyOptions}}
                        <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
                        {{/each}}
                    </select>
                </div>
                <div class="crafting-zone-ingredients-list">
                    {{#each listItems}}
                    <div class="crafting-ingredient-row {{#if this.isContainer}}crafting-container-row{{/if}}" data-action="{{this.addAction}}" data-item-id="{{this.id}}" data-item-uuid="{{this.uuid}}" data-tooltip="{{this.name}}{{#if this.tags}}\nTags: {{this.tags}}{{/if}}" tabindex="0" title="{{this.name}}">
                        <img src="{{this.img}}" alt="" class="crafting-ingredient-row-img" />
                        <div class="crafting-ingredient-row-info">
                            <span class="crafting-ingredient-row-name">{{this.name}}</span>
                            <span class="crafting-ingredient-row-qty">×{{this.quantity}}</span>
                        </div>
                    </div>
                    {{else}}
                    <div class="crafting-zone-empty">{{#if showApparatusOnly}}No apparatus in inventory.{{else}}{{#if showContainerOnly}}No containers in inventory.{{else}}{{#if showToolOnly}}No skill kit in inventory.{{else}}No components or vessels in inventory.{{/if}}{{/if}}{{/if}}</div>
                    {{/each}}
                </div>
            </section>
        </aside>

        {{!-- Zone 3: Crafting area --}}
        <main class="crafting-zone crafting-zone-bench">
            <section class="crafting-zone-section">
                <h3 class="crafting-zone-section-title">Crafting Bench</h3>
                {{!-- 6 ingredient slots (2 rows x 3) --}}
                <div class="crafting-bench-ingredient-slots">
                    {{#each slots}}
                    <div class="crafting-bench-slot {{#if this.isMissing}}crafting-bench-slot-missing{{/if}}" data-slot-index="{{@index}}">
                        {{#if this.item}}
                        <div class="crafting-bench-slot-item" data-action="removeFromSlot" data-slot-index="{{@index}}" data-tooltip="{{this.tooltip}}" title="{{this.tooltip}}">
                            <img src="{{this.item.img}}" alt="" class="crafting-slot-img" />
                        </div>
                        <span class="crafting-bench-slot-count {{#if this.isMissing}}missing{{/if}}">{{this.count}}</span>
                        {{else}}
                        <div class="crafting-bench-slot-empty">Empty</div>
                        {{/if}}
                    </div>
                    {{/each}}
                </div>
                {{!-- Row 2: 3-column grid - Skill (left, no border) | Apparatus (center, like slots) | Timer (right, no border) --}}
                <div class="crafting-bench-grid-row crafting-bench-apparatus-row">
                    <div class="crafting-bench-grid-cell crafting-bench-grid-cell-center">
                        <div class="crafting-bench-tool-slot crafting-bench-vessel-slot {{#if toolSlot.isMissing}}crafting-bench-vessel-missing{{/if}}" data-action="removeTool" data-tooltip="{{toolSlot.tooltip}}" title="{{#if toolSlot.tooltip}}{{toolSlot.tooltip}}{{else}}Skill{{/if}}">
                            {{#if toolSlot.item}}
                            <div class="crafting-bench-container-item"><img src="{{toolSlot.item.img}}" alt="" class="crafting-container-img" /></div>
                            {{else}}{{#if toolSlot.requiredItem}}
                            <div class="crafting-bench-container-item crafting-bench-container-required"><img src="{{toolSlot.requiredItem.img}}" alt="" class="crafting-container-img" /></div>
                            {{else}}
                        <div class="crafting-bench-container-empty">
                            <i class="fa-solid fa-toolbox"></i>
                            <span>Skill</span>
                        </div>
                            {{/if}}{{/if}}
                        </div>
                    </div>
                    <div class="crafting-bench-grid-cell">
                        <div class="crafting-bench-apparatus-slot crafting-bench-center-slot {{#if apparatusSlot.isMissing}}crafting-bench-vessel-missing {{/if}}{{#if isCrafting}}crafting-bench-apparatus-crafting{{/if}}{{#if isGrinding}} crafting-bench-apparatus-grinding{{/if}}" data-action="removeApparatus" data-tooltip="{{apparatusSlot.tooltip}}" title="{{#if apparatusSlot.tooltip}}{{apparatusSlot.tooltip}}{{else}}Apparatus{{/if}}" style="--heat: {{heat}};" {{#if heatUnstable}}data-unstable="true"{{/if}}>
                            {{#if apparatusSlot.item}}
                            <div class="crafting-bench-container-item"><img src="{{apparatusSlot.item.img}}" alt="" class="crafting-container-img" /></div>
                            {{else}}{{#if apparatusSlot.requiredItem}}
                            <div class="crafting-bench-container-item crafting-bench-container-required"><img src="{{apparatusSlot.requiredItem.img}}" alt="" class="crafting-container-img" /></div>
                            {{else}}
                            <div class="crafting-bench-container-empty">
                                <i class="fa-solid fa-flask"></i>
                                <span>Apparatus</span>
                            </div>
                            {{/if}}{{/if}}
                        </div>
                    </div>
                    <div class="crafting-bench-grid-cell crafting-bench-grid-cell-center">
                        <div class="crafting-bench-round-timer-wrap" title="{{#if isCrafting}}Crafting in progress...{{else}}Time: 0 sec to 2 min (click ring to set){{/if}}">
                            <div class="crafting-bench-round-timer" data-action="setTimeFromRoundTimer">
                                <div class="crafting-bench-round-timer-ring" style="--time-fill: {{timeFillPercent}}%;"></div>
                                <div class="crafting-bench-round-timer-center">
                                    <span class="crafting-bench-round-timer-value">{{timeDisplayText}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {{!-- Row 3: Process widget (heat / grind) with cycle arrows --}}
                <div class="crafting-bench-process-row">
                    <button type="button" class="crafting-bench-process-cycle-arrow" data-action="cycleProcessPrev" title="Previous process (heat / grind)" aria-label="Previous process">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <div class="crafting-bench-process-slider-wrap widget-{{processType}}" title="{{#if isHeatProcess}}Heat: Off, Low, Medium, High{{else}}Grind: Off, Coarse, Medium, Fine{{/if}}">
                        <div class="crafting-bench-process-slider-label">{{#if isHeatProcess}}Heat: {{processLabel}}{{else}}Grind: {{processLabel}}{{/if}}</div>
                        <div class="crafting-bench-process-slider-row">
                            <div class="crafting-bench-process-slider-left">{{processLeftLabel}}</div>
                            <div class="crafting-bench-process-slider-track">
                                <input type="range" id="{{appId}}-process-{{processType}}" class="crafting-bench-horizontal-slider crafting-bench-heat-slider-input" min="0" max="3" value="{{processValue}}" step="1" data-craft-setting="{{processType}}" data-craft-setting-min="0" data-craft-setting-max="3" style="--heat-fill: {{processFillPercent}}%;" />
                            </div>
                            <div class="crafting-bench-process-slider-right">{{processRightLabel}}</div>
                        </div>
                    </div>
                    <button type="button" class="crafting-bench-process-cycle-arrow" data-action="cycleProcessNext" title="Next process (heat / grind)" aria-label="Next process">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
                {{!-- Row 4: 3-column grid - empty (left, no border) | Container (center, like slots) | empty (right, no border) --}}
                <div class="crafting-bench-grid-row crafting-bench-container-row">
                    <div class="crafting-bench-grid-cell crafting-bench-grid-cell-empty"></div>
                    <div class="crafting-bench-grid-cell">
                        <div class="crafting-bench-container-slot crafting-bench-center-slot {{#if containerSlot.isMissing}}crafting-bench-vessel-missing {{/if}}{{#if containerSlot.item}}{{#if isCrafting}} crafting-bench-container-slot-fill{{/if}}{{/if}}" data-action="removeContainer" data-tooltip="{{containerSlot.tooltip}}" title="{{#if containerSlot.tooltip}}{{containerSlot.tooltip}}{{else}}Container{{/if}}"{{#if containerSlot.item}}{{#if isCrafting}} style="--craft-fill-percent: {{containerCraftFillPercent}}"{{/if}}{{/if}}>
                            {{#if containerSlot.item}}
                            <div class="crafting-bench-container-item"><img src="{{containerSlot.item.img}}" alt="" class="crafting-container-img" /></div>
                            {{else}}{{#if containerSlot.requiredItem}}
                            <div class="crafting-bench-container-item crafting-bench-container-required"><img src="{{containerSlot.requiredItem.img}}" alt="" class="crafting-container-img" /></div>
                            {{else}}
                            <div class="crafting-bench-container-empty">
                                <i class="fa-solid fa-vial"></i>
                                <span>Container</span>
                            </div>
                            {{/if}}{{/if}}
                        </div>
                    </div>
                    <div class="crafting-bench-grid-cell crafting-bench-grid-cell-empty"></div>
                </div>
            </section>
        </main>

        {{!-- Zone 4: Details (scrollable when recipe selected) --}}
        <aside class="crafting-zone crafting-zone-result">
            <section class="crafting-zone-section">
                <h3 class="crafting-zone-section-title">Details</h3>
                <div class="crafting-details-content">
                    {{#if combinedTags.length}}
                    <p class="crafting-zone-desc">Traits for this combination:</p>
                    <div class="crafting-bench-tags">
                        {{#each combinedTags}}
                        <span class="crafting-tag-badge">{{this}}</span>
                        {{/each}}
                    </div>
                    {{/if}}
                    {{#if selectedRecipeData}}
                    <hr class="crafting-details-divider" />
                    <div class="crafting-recipe-details">
                        <div class="crafting-recipe-name">{{selectedRecipeData.name}}</div>
                        <div class="crafting-recipe-result-name">Result: {{selectedRecipeData.resultName}}</div>
                        {{#if selectedRecipeData.traits.length}}
                        <div class="crafting-recipe-traits">
                            {{#each selectedRecipeData.traits}}
                            <span class="crafting-tag-badge">{{this}}</span>
                            {{/each}}
                        </div>
                        {{/if}}
                        {{#if selectedRecipeData.description}}
                        <div class="crafting-recipe-description">{{{selectedRecipeData.description}}}</div>
                        {{/if}}
                    </div>
                    {{#if selectedRecipeMetadata.length}}
                    <hr class="crafting-details-divider" />
                    <div class="crafting-recipe-metadata">
                        {{#each selectedRecipeMetadata}}
                        <div class="crafting-metadata-line">{{this}}</div>
                        {{/each}}
                    </div>
                    {{/if}}
                    {{/if}}
                    {{#if lastResult}}
                    <hr class="crafting-details-divider" />
                    <div class="crafting-result-box {{#if lastResult.success}}crafting-result-success{{else}}crafting-result-fail{{/if}}">
                        <div class="crafting-result-row crafting-ingredient-row">
                            {{#if lastResult.item}}
                            <img src="{{lastResult.item.img}}" alt="" class="crafting-ingredient-row-img" />
                            {{else}}
                            <i class="fa-solid {{#if lastResult.success}}fa-check{{else}}fa-times{{/if}} crafting-result-fallback-icon"></i>
                            {{/if}}
                            <div class="crafting-ingredient-row-info">
                                <span class="crafting-result-name crafting-ingredient-row-name">{{lastResult.name}}</span>
                                {{#if lastResult.item}}
                                <span class="crafting-ingredient-row-qty">×1</span>
                                {{else}}
                                <span class="crafting-result-detail crafting-ingredient-row-qty">Tags: {{lastCraftTagsStr}}</span>
                                {{/if}}
                            </div>
                        </div>
                    </div>
                    {{else}}
                    {{#unless selectedRecipeData}}
                    <div class="crafting-zone-empty">Select a recipe or craft to see result.</div>
                    {{/unless}}
                    {{/if}}
                </div>
            </section>
        </aside>
    </div>

    {{!-- ACTION BAR: [ REFRESH ] status text                    [ CLEAR ] [ CRAFT ] --}}
    <section class="crafting-window-buttons">
        <div class="crafting-window-action-bar">
            <div class="crafting-window-action-left">
                <button type="button" class="crafting-window-btn-secondary" data-action="refreshCache" {{#if cacheStatus.building}}disabled{{/if}} title="Build or refresh item cache (compendia + world)">
                    <i class="fa-solid fa-database"></i> Refresh
                </button>
                <span class="crafting-window-cache-status">
                    {{#if cacheStatus.building}}
                    <i class="fa-solid fa-spinner fa-spin"></i> {{cacheStatus.message}}
                    {{else if cacheStatus.hasCache}}
                    {{cacheStatus.message}}
                    {{else}}
                    No Cache: Refresh to Build
                    {{/if}}
                </span>
            </div>
            <div class="crafting-window-action-right">
                <button type="button" class="crafting-window-btn-secondary" data-action="clear" title="Clear all slots">
                    <i class="fa-solid fa-eraser"></i> Clear
                </button>
                <button type="button" class="crafting-window-btn-primary" data-action="craft" {{#unless canCraft}}{{#unless isCrafting}}disabled{{/unless}}{{/unless}} {{#if isCrafting}}disabled{{/if}} title="{{#if isCrafting}}Crafting in progress...{{else}}Craft with selected ingredients{{/if}}">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Craft
                </button>
            </div>
        </div>
    </section>
</div>
